<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Explorer</title>
  <!-- CDN styling (fine for dev). For production, prebuild Tailwind per docs. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>html,body{height:100%}body{background:#0b0c10;color:#e6e8ee}.scroll-thin{scrollbar-width:thin}</style>
  <!-- Must exist and define:  const demoFS = { name:'root', type:'folder', children:[ ... ] } -->
  <script src="data.js"></script>
</head>
<body class="min-h-full">
  <div class="grid grid-rows-[auto,1fr] h-screen">
    <header class="sticky top-0 z-10 border-b border-slate-800 bg-slate-900/70 backdrop-blur">
      <div class="flex items-center gap-3 px-4 py-2">
        <div class="flex items-center gap-2 font-semibold">
          <span class="inline-grid place-items-center w-7 h-7 rounded-xl bg-blue-500 text-white shadow">üìÅ</span>
          <span>Explorer</span>
        </div>
        <div class="ml-auto flex items-center gap-2 w-full max-w-xl">
          <div class="relative flex-1">
            <input id="search" placeholder="Search‚Ä¶ (Ctrl+/)" class="w-full rounded-full border border-slate-700 bg-slate-800/70 px-9 py-2 outline-none focus:ring-2 focus:ring-blue-500" />
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 opacity-70" viewBox="0 0 24 24" fill="currentColor"><path d="M10 4a6 6 0 1 1 0 12 6 6 0 0 1 0-12zm8.32 12.9 3.39 3.39-1.41 1.41-3.39-3.39A8.96 8.96 0 0 1 10 20 9 9 0 1 1 19 11c0 2.2-.8 4.22-2.11 5.9z"/></svg>
          </div>
          <label class="text-sm text-slate-300">Sort
            <select id="sort" class="ml-2 rounded-lg border border-slate-700 bg-slate-800/70 px-2 py-2">
              <option value="name">Name</option>
              <option value="type">Type</option>
              <option value="size">Size</option>
              <option value="modified">Modified</option>
            </select>
          </label>
          <button id="toggleView" class="rounded-lg border border-slate-700 bg-slate-800/70 px-3 py-2">Toggle View</button>
        </div>
      </div>
    </header>

    <div class="grid grid-cols-[260px,1fr] min-h-0">
      <aside class="border-r border-slate-800 bg-slate-900/40 p-2 overflow-auto scroll-thin" aria-label="Folders">
        <ul id="tree" class="space-y-1"></ul>
      </aside>

      <main class="min-w-0 overflow-auto p-3">
        <nav id="breadcrumbs" class="text-slate-400 text-sm flex items-center gap-1"></nav>
        <section class="mt-3">
          <div id="gridView" class="grid grid-cols-[repeat(auto-fill,minmax(180px,1fr))] gap-3"></div>
          <div id="listView" class="hidden"></div>
        </section>
      </main>
    </div>
  </div>

<script>
  // ===== Config & Guards =====
  const BASE = (window.BASE_URL || ''); // set window.BASE_URL before this script if you want a base
  function ensureModel(){
    if (!window.demoFS || typeof window.demoFS !== 'object'){
      console.error('[Explorer] data.js missing or invalid. Using empty model.');
      window.demoFS = { name:'root', type:'folder', children:[] };
    }
    if (!Array.isArray(window.demoFS.children)) window.demoFS.children = [];
    return window.demoFS;
  }

  // ===== Utilities =====
  let currentPath = ['/'];
  let gridMode = true;
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const fmtBytes = n=>{ if(n==null) return ''; const u=['B','KB','MB','GB','TB']; let i=0,v=n; while(v>=1024&&i<u.length-1){v/=1024;i++;} return `${v.toFixed(v<10&&i>0?1:0)} ${u[i]}`; };
  const fmtDate = t=> t? new Date(t).toLocaleString() : '';
  const fileIcon = it => it.type==='folder'?'üìÇ':'üì¶';

  function getNode(pathArr){
    let node = ensureModel();
    for(let i=1;i<pathArr.length;i++){
      const next = (node.children||[]).find(c=>c.type==='folder' && c.name===pathArr[i]);
      if(!next) return node; // stop at deepest valid
      node = next;
    }
    return node;
  }

  function relPathFor(it){
    // Build relative path from root for a file inside the current node
    return encodeURI([ ...currentPath.slice(1), it.name ].join('/'));
  }

  function openItem(it){
    if (it.type==='folder'){ currentPath.push(it.name); update(); return; }
    // prefer generator-provided URL; else fallback to BASE + relative path
    const href = it.url || (BASE + relPathFor(it));
    window.location.assign(href);
  }

  // ===== UI Renderers =====
  function renderTree(){
    const ul = $('#tree'); ul.innerHTML='';
    (ensureModel().children||[]).filter(c=>c.type==='folder').forEach(child=>{
      const li = document.createElement('li');
      li.innerHTML = `<button class="w-full text-left px-2 py-2 rounded-lg hover:bg-slate-800/70">${fileIcon(child)} <span class=\"ml-1\">${child.name}</span></button>`;
      li.firstElementChild.addEventListener('click', ()=>{ currentPath=['/', child.name]; update(); });
      ul.appendChild(li);
    });
  }

  function renderBreadcrumb(){
    const nav = $('#breadcrumbs'); nav.innerHTML='';
    currentPath.forEach((seg,i)=>{
      if(i>0){ const s=document.createElement('span'); s.textContent='‚Ä∫'; s.className='opacity-50'; nav.appendChild(s); }
      const a=document.createElement('a'); a.href='#'; a.textContent = seg==='/'? 'Home' : seg; a.className='hover:underline';
      a.addEventListener('click', e=>{ e.preventDefault(); currentPath=currentPath.slice(0,i+1); update(); });
      nav.appendChild(a);
    });
  }

  function sortedFiltered(node){
    const q = ($('#search')?.value||'').toLowerCase();
    const sort = ($('#sort')?.value)||'name';
    const items = (node.children||[]).slice();
    const cmp = {
      name:(a,b)=>a.name.localeCompare(b.name),
      type:(a,b)=> (a.type+a.name).localeCompare(b.type+b.name),
      size:(a,b)=> (a.size||0)-(b.size||0),
      modified:(a,b)=> (a.modified||0)-(b.modified||0)
    }[sort] || ((a,b)=>a.name.localeCompare(b.name));
    items.sort(cmp);
    return q? items.filter(i=>i.name.toLowerCase().includes(q)) : items;
  }

  function renderGrid(){
    const grid = $('#gridView'); grid.innerHTML='';
    const node = getNode(currentPath);
    for(const it of sortedFiltered(node)){
      const btn = document.createElement('button');
      btn.className='text-left rounded-2xl border border-slate-800 bg-slate-900/60 p-3 transition hover:-translate-y-0.5';
      btn.innerHTML = `<div class="text-3xl">${fileIcon(it)}</div>
        <div class="mt-2 font-semibold truncate">${it.name}</div>
        <div class="text-xs text-slate-400">${it.type==='folder'?'Folder':fmtBytes(it.size)} ‚Ä¢ ${fmtDate(it.modified)}</div>`;
      btn.addEventListener('dblclick', ()=>openItem(it));
      btn.addEventListener('keydown', e=>{ if(e.key==='Enter') openItem(it); });
      grid.appendChild(btn);
    }
  }

  function renderList(){
    const root = $('#listView'); root.innerHTML='';
    const node = getNode(currentPath);
    for(const it of sortedFiltered(node)){
      const btn = document.createElement('button');
      btn.className='w-full text-left border border-slate-800 bg-slate-900/60 px-3 py-2 rounded-xl mb-2';
      btn.innerHTML = `<span class="mr-2">${fileIcon(it)}</span>${it.name}
        <span class="ml-2 text-xs text-slate-400">${it.type==='folder'?'Folder':fmtBytes(it.size)} ‚Ä¢ ${fmtDate(it.modified)}</span>`;
      btn.addEventListener('dblclick', ()=>openItem(it));
      btn.addEventListener('keydown', e=>{ if(e.key==='Enter') openItem(it); });
      root.appendChild(btn);
    }
  }

  function update(){
    renderBreadcrumb();
    if (gridMode){ $('#gridView').classList.remove('hidden'); $('#listView').classList.add('hidden'); renderGrid(); }
    else { $('#gridView').classList.add('hidden'); $('#listView').classList.remove('hidden'); renderList(); }
  }

  // Boot
  window.addEventListener('DOMContentLoaded', ()=>{
    // Keyboard focus to search
    document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key === '/'){ e.preventDefault(); $('#search').focus(); } });
    renderTree();
    update();
    $('#toggleView').addEventListener('click', ()=>{ gridMode = !gridMode; update(); });
    $('#search').addEventListener('input', update);
  });
</script>
</body>
</html>